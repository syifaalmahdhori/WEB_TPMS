<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Realtime Data â€“ TPMS Fuzzy Sugeno</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { background:#0b1220; color:#e9edf3; }

    /* Sidebar & Layout */
    :root {
      --sidebar-w: 256px;
      --sidebar-bg: #0e1626;
      --sidebar-border: #1f2b46;
      --sidebar-link: #c7d2e5;
      --sidebar-link-active-bg: #16233b;
      --sidebar-link-active: #ffffff;
    }
    .topbar { position: sticky; top: 0; z-index: 1050; background:#0b1220; border-bottom:1px solid #1f2b46; }
    .content-wrap { transition: margin-left .25s ease; }
    .sidebar {
      position: fixed; inset: 0 auto 0 0; width: var(--sidebar-w);
      background: var(--sidebar-bg); border-right:1px solid var(--sidebar-border);
      transform: translateX(-100%); transition: transform .25s ease; padding-top:60px; z-index:1040;
    }
    .sidebar.show { transform: translateX(0); }
    @media (min-width: 992px){
      .sidebar { transform: none; padding-top:0; }
      .content-wrap { margin-left: var(--sidebar-w); }
      .topbar .btn-toggle { display:none; }
    }
    .sidebar .brand { padding:16px 18px; border-bottom:1px solid var(--sidebar-border); font-weight:700; }
    .sidebar .nav-link { color:var(--sidebar-link); padding:10px 16px; border-radius:.5rem; margin:4px 8px; }
    .sidebar .nav-link:hover { background:rgba(255,255,255,.05); color:#fff; }
    .sidebar .nav-link.active { background:var(--sidebar-link-active-bg); color:var(--sidebar-link-active); }
    .sidebar small.section { display:block; color:#8fa1bf; padding:10px 18px 4px; margin-top:8px; text-transform:uppercase; font-size:.73rem; }

    /* Card & Form */
    .card { background:#121a2b; border:1px solid #1f2b46; }
    .card-header { background:#0e1626; border-bottom:1px solid #1f2b46; color:#fff; }
    .form-control, .form-select { background:#0e1626; color:#e9edf3; border-color:#1f2b46; }
    .form-control::placeholder { color:#8fa1bf; }

    /* Metric Cards */
    .metric { background:#0e1626; border:1px dashed #223153; }
    .metric .label { color:#a7b3c6; }
    .metric .value { font-weight:700; }

    /* Status Badges */
    .status-badge { border-radius:2rem; padding:.35rem .75rem; font-weight:700; }
    .bg-aman { background:rgba(0,255,157,.15); color:rgb(0,255,157); border:1px solid rgba(0,255,157,.35); }
    .bg-waspada { background:rgba(255,213,79,.15); color:rgb(255,213,79); border:1px solid rgba(255,213,79,.35); }
    .bg-bahaya { background:rgba(255,99,132,.15); color:rgb(255,99,132); border:1px solid rgba(255,99,132,.35); }
    .bg-dummy { background:rgba(0,224,255,.2); color:rgb(0,224,255); border:1px solid rgba(0,224,255,.3); }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="container-fluid py-2 d-flex align-items-center justify-content-between">
      <button class="btn btn-outline-light btn-sm btn-toggle" onclick="toggleSidebar()">â˜°</button>
      <div class="small text-muted">TPMS â€“ Data Realtime</div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <nav id="sidebar" class="sidebar">
    <div class="brand">TPMS Dashboard</div>
    <small class="section">Navigasi</small>
    <ul class="nav flex-column mb-2">
      <li class="nav-item"><a class="nav-link" href="index.html">Beranda</a></li>
      <li class="nav-item"><a class="nav-link" href="membership.html">Membership Function</a></li>
      <li class="nav-item"><a class="nav-link" href="rules.html">Aturan (Rule Base)</a></li>
      <li class="nav-item"><a class="nav-link" href="charts.html">Grafik & Hasil</a></li>
      <li class="nav-item"><a class="nav-link active" href="realtime.html">Realtime</a></li>
      <li class="nav-item"><a class="nav-link" href="table.html">Tabel Data</a></li>
      <li class="nav-item"><a class="nav-link" href="about.html">Tentang</a></li>
    </ul>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="content-wrap">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 fw-bold mb-0">Monitoring Data Realtime</h1>
        <div class="d-flex gap-2 align-items-center">
          <span id="dummyBadge" class="status-badge bg-dummy d-none">Dummy Mode</span>
          <span id="statusBadge" class="status-badge bg-waspada">Waspada</span>
        </div>
      </div>

      <p class="text-secondary mb-4">Pantau tekanan, suhu, dan kecepatan dari ESP32 secara realtime. Kamu bisa aktifkan <strong>Mode Dummy</strong> untuk uji simulasi tanpa ESP32.</p>

      <!-- CONTROL PANEL -->
      <div class="card mb-4">
        <div class="card-header"><strong>Pengaturan Koneksi</strong></div>
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-lg-5">
              <label class="form-label">Endpoint ESP32</label>
              <input id="endpoint" type="text" class="form-control" placeholder="http://192.168.4.1/data">
            </div>
            <div class="col-lg-3">
              <label class="form-label">Interval Update</label>
              <select id="intervalMs" class="form-select">
                <option value="500">500 ms</option>
                <option value="1000" selected>1000 ms</option>
                <option value="2000">2000 ms</option>
                <option value="5000">5000 ms</option>
              </select>
            </div>
            <div class="col-lg-4 d-flex gap-2">
              <button id="btnStart" class="btn btn-success flex-grow-1">â–¶ Start</button>
              <button id="btnStop" class="btn btn-outline-light flex-grow-1" disabled>â–  Stop</button>
              <button id="btnDummy" class="btn btn-info flex-grow-1">ðŸ’¡ Dummy</button>
            </div>
          </div>
        </div>
      </div>

      <!-- DATA CARDS -->
      <div class="row g-3 mb-4 text-center">
        <div class="col-md-3"><div class="p-3 rounded-3 metric"><div class="label">Tekanan</div><div id="valTekanan" class="h2 value text-info">0.0</div><small>psi</small></div></div>
        <div class="col-md-3"><div class="p-3 rounded-3 metric"><div class="label">Suhu</div><div id="valSuhu" class="h2 value text-warning">0.0</div><small>Â°C</small></div></div>
        <div class="col-md-3"><div class="p-3 rounded-3 metric"><div class="label">Kecepatan</div><div id="valSpeed" class="h2 value text-success">0.0</div><small>km/jam</small></div></div>
        <div class="col-md-3"><div class="p-3 rounded-3 metric"><div class="label">Status</div><div id="valStatus" class="h2 value text-secondary">-</div> <small class="text-secondary">Aman / Waspada / Bahaya</small></div></div>
      </div>

      <!-- GRAFIK -->
      <div class="card">
        <div class="card-header"><strong>Grafik Sensor (Realtime)</strong></div>
        <div class="card-body"><canvas id="chartRealtime" height="120"></canvas></div>
      </div>

      <footer class="text-center small text-secondary mt-4">Â© 2025 â€“ TPMS Fuzzy Sugeno</footer>
    </div>
  </main>

  <script>
    const $ = id => document.getElementById(id);
    function toggleSidebar(){ $('sidebar').classList.toggle('show'); }

    let dummyMode = false, timer = null;

    // Chart setup
    const ctx = $('chartRealtime');
    const chart = new Chart(ctx,{
      type:'line',
      data:{labels:[],datasets:[
        {label:'Tekanan', borderColor:'rgb(0,200,255)', data:[], tension:0.25, pointRadius:0},
        {label:'Suhu', borderColor:'rgb(255,213,79)', data:[], tension:0.25, pointRadius:0},
        {label:'Kecepatan', borderColor:'rgb(0,255,157)', data:[], tension:0.25, pointRadius:0}
      ]},
      options:{
        animation:false,
        scales:{
          x:{ticks:{color:'#e9edf3'},grid:{color:'rgba(255,255,255,0.05)'}},
          y:{min:0,max:120,ticks:{color:'#e9edf3'},grid:{color:'rgba(255,255,255,0.05)'}}
        },
        plugins:{legend:{labels:{color:'#e9edf3'}}}
      }
    });

    function updateChart(t, s, k){
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now);
      chart.data.datasets[0].data.push(t);
      chart.data.datasets[1].data.push(s);
      chart.data.datasets[2].data.push(k);
      if(chart.data.labels.length>30){
        chart.data.labels.shift();
        chart.data.datasets.forEach(d=>d.data.shift());
      }
      chart.update();
    }

    function setStatus(status){
      const badge=$('statusBadge');
      badge.className='status-badge';
      if(status==='Aman') badge.classList.add('bg-aman');
      else if(status==='Bahaya') badge.classList.add('bg-bahaya');
      else badge.classList.add('bg-waspada');
      badge.textContent=status;
      $('valStatus').className='h2 value '+(status==='Aman'?'text-success':status==='Bahaya'?'text-danger':'text-warning');
      $('valStatus').textContent=status;
    }

    function simulate(){
      return {
        tekanan:20+Math.random()*10,
        suhu:25+Math.random()*5,
        kecepatan:40+Math.random()*10,
        status:['Aman','Waspada','Bahaya'][Math.floor(Math.random()*3)]
      };
    }

    async function fetchData(){
      let data;
      if(dummyMode){ data=simulate(); }
      else{
        try{
          const ep=$('endpoint').value.trim();
          const res=await fetch(ep);
          data=await res.json();
        }catch(e){ data=simulate(); }
      }
      $('valTekanan').textContent=data.tekanan.toFixed(1);
      $('valSuhu').textContent=data.suhu.toFixed(1);
      $('valSpeed').textContent=data.kecepatan.toFixed(1);
      setStatus(data.status);
      updateChart(data.tekanan,data.suhu,data.kecepatan);
    }

    $('btnStart').onclick=()=>{
      if(timer) clearInterval(timer);
      timer=setInterval(fetchData,Number($('intervalMs').value));
      fetchData();
      $('btnStart').disabled=true;
      $('btnStop').disabled=false;
    };
    $('btnStop').onclick=()=>{
      clearInterval(timer);
      timer=null;
      $('btnStart').disabled=false;
      $('btnStop').disabled=true;
    };

    $('btnDummy').onclick=()=>{
      dummyMode=!dummyMode;
      $('dummyBadge').classList.toggle('d-none',!dummyMode);
      $('btnDummy').classList.toggle('btn-info',!dummyMode);
      $('btnDummy').classList.toggle('btn-outline-info',dummyMode);
      $('btnDummy').textContent=dummyMode?'ðŸš€ Dummy Aktif':'ðŸ’¡ Dummy';
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
